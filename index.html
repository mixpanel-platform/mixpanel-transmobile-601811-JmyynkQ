<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id='transMobilePie'></div>
    <script>
      // formatting the pie chart//
      
            console.log("boogie woogie");
      
      
      var pieChart = $('#transMobilePie').MPChart(
              {
                  chartType: 'pie',
              });
      //Query top properties to receive property data//
      
      var topProperties = function(){
        var params = {
                    from: '2015-01-01',
                    to: '2015-04-15',
                    type: 'unique',
                    where: 'properties["LocusTest"] == false'
                };
        
        var topTransMobileProps = MP.api.propertyValues('DailyReport', 'TransMobile', params).done(function (results){
          console.log("These are our results");
          console.log(results.values());
          var propsForQuerying = results.values();
          //var orderedKeys = Object.keys(propsForQuerying).sort().reverse();
          
          //creating new object with property values as keys
          var sortedTransMobileProps = {};
          for(var i = 0; i < Object.keys(propsForQuerying).length ; i++){
            var newKey = propsForQuerying[i];
            console.log(newKey);
            sortedTransMobileProps[newKey] = 0;
            
          }
             console.log("sortedTransMobileProps");
          console.log(sortedTransMobileProps);
          queryPeople(sortedTransMobileProps);
        });
        
        
      }
      
      var queryPeople = function (sortedTransMobileProps) {
        var promises = [];
        for (var i = 0; i<Object.keys(sortedTransMobileProps).length; i++){
          var peopleParams = {
              where: "((properties[\"TransMobile\"] == \"" + String(Object.keys(sortedTransMobileProps)[i]) + "\"))"
            };
            promises.push(MP.api.people(peopleParams));
          
        }
        Promise.all(promises).then(function(promiseArray){
          for (var i = 0; i < promiseArray.length; i++){
            sortedTransMobileProps[Object.keys(sortedTransMobileProps)[i]] = promiseArray[i].values()['total'];
          }
          pieChart.MPChart('setData', sortedTransMobileProps);

        
        })
        console.log("this is our final data");
        console.log(sortedTransMobileProps);
        
      }
        
  
      
      topProperties();
              
              
              
    </script>
  </body>
</html>
