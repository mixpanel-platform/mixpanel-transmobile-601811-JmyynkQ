<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <script>
      // formatting the pie chart//
      
            console.log("boogie woogie");
      
            var dateSelect = $('#dateSelect').MPDatepicker();

            var piePlotOptions = {
                pie: {
                    dataLabels: {
                        enabled: false,
                        distance: 5
                    },
                    showInLegend: true
                }
            };
            
            console.log("pie legend");
            var pieLegend = {
                align: 'right',
                borderRadius: 0,
                borderWidth: 0,
                enabled: true,
                floating: false,
                itemMarginBottom: 1,
                itemMarginTop: 1,
                itemStyle: { "color": "#333333", "cursor": "pointer", "fontSize": "12px", "fontWeight": "normal" },
                layout: 'vertical',
                margin: 2,
                padding: 2,
                symbolHeight: 8,
                symbolPadding: 5,
                symbolRadius: 4,
                symbolWidth: 8,
                verticalAlign: 'center',
                x: 0,
                y: 0,
            }

      console.log("pieChart");
      var pieChart = $('#transMobilePie').MPChart(
              {
                  chartType: 'pie',
                  highchartsOptions: {
                      chart: {
                          marginBottom: 0
                      },
                      legend: pieLegend,
                      plotOptions: piePlotOptions,
                      colors: ['#109618', '#ff9900', '#dc3912', '#000000', '#000000', '#000000', '#000000', '#000000', '#000000', '#000000', '#000000']
                  }
              });
      //Query top properties to receive property data//
      
      var topProperties = function(){
        console.log("dateRange");
        var dateRange = dateSelect.MPDatepicker('value');
        console.log(dateRange.from);
        var params = {
                    from: '2015-01-01',
                    to: '2015-04-15',
                    type: 'unique',
                    where: 'properties["LocusTest"] == false'
                };
        console.log(params);
        var topTransMobileProps = MP.api.propertyValues('DailyReport', 'TransMobile', params).done(function (results){
          console.log("These are our results");
          console.log(results.values());
          var propsForQuerying = results.values();
          //var orderedKeys = Object.keys(propsForQuerying).sort().reverse();
          
          //creating new object with property values as keys
          var sortedTransMobileProps = {};
          for(var i = 0; i < Object.keys(propsForQuerying).length; i++){
            sortedTransMobileProps[ propsForQuerying[i] ] = 0;
            
          }
          console.log(sortedTransMobileProps);
          
          //for each property value, query people and sum number of profiles with specified property
          for (var i = 0; i < Object.keys(sortedTransMobileProps).length; i++){
            var peopleParams = {
              where: "'properties['TransMobile'] == '" + sortedTransMobile[i].toString();
            };
            var peopleTransMobile = MP.api.people(peopleParams).done(function(results){
              console.log(results);
            });
            
          }

          })
    }
        
  
      
      topProperties();
              
              
              
    </script>
  </body>
</html>
